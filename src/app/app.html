<div
  [class]="'h-screen flex overflow-hidden font-sans transition-colors duration-1000 ' + currentBiome().colors.background">

  <!-- Game Area (100% on mobile, 80% on desktop) -->
  <div class="flex-1 h-full relative overflow-hidden">

    <!-- SVG Canvas -->
    <svg [attr.viewBox]="viewBox()" class="w-full h-full drop-shadow-2xl overflow-visible pointer-events-none">

      <!-- 1. Baked Legacy Trees (Background) -->
      <g class="opacity-80 grayscale-[30%]">
        @for (tree of legacyTrees(); track tree.id) {
        <g style="transform-origin: center bottom">
          @for (path of tree.paths; track $index) {
          @if (path.d) {
          <path [attr.d]="path.d" [attr.stroke]="path.stroke" [attr.stroke-width]="path.width" [attr.fill]="path.fill"
            stroke-linecap="round" />
          } @else {
          <ellipse [attr.cx]="path.cx" [attr.cy]="path.cy" [attr.rx]="path.r || 6" [attr.ry]="path.r || 8"
            [attr.fill]="path.fill" />
          }
          }
          <!-- Score Label on tree -->
          <text [attr.x]="tree.x" [attr.y]="tree.y - 100" font-size="12" fill="white" text-anchor="middle"
            class="font-bold drop-shadow-md">+{{ tree.score }}</text>
        </g>
        }
      </g>

      <!-- 2. Active Tree (Dynamic) -->
      <g class="pointer-events-auto transition-transform duration-300" style="transform-origin: center bottom">
        @for (path of treeData().paths; track $index) {
        @if (path.d) {
        <path [attr.d]="path.d" [attr.stroke]="path.stroke" [attr.stroke-width]="path.width" [attr.fill]="path.fill"
          stroke-linecap="round" class="transition-all duration-500" />
        } @else {
        <ellipse [attr.cx]="path.cx" [attr.cy]="path.cy" [attr.rx]="path.r || 6" [attr.ry]="path.r || 8"
          [attr.fill]="path.fill" class="transition-all duration-500" />
        }
        }

        <!-- Fruits (Active Tree Only) -->
        @for (fruit of renderedFruits(); track $index) {
        <g class="cursor-pointer hover:scale-125 transition-transform origin-center animate-float-in"
          (click)="harvestFruit(fruit.id); $event.stopPropagation()">
          <circle [attr.cx]="fruit.cx" [attr.cy]="fruit.cy" r="8" fill="#FCD34D" class="animate-pulse opacity-50" />
          <circle [attr.cx]="fruit.cx" [attr.cy]="fruit.cy" r="5" fill="#F59E0B" stroke="#FBBF24" stroke-width="1" />
        </g>
        }
      </g>
    </svg>

    <!-- WILDCARD EFFECT INDICATOR -->
    @if (lastWildcardEffect()) {
    <div class="absolute top-1/4 left-1/2 -translate-x-1/2 z-50 animate-bounce pointer-events-none">
      <div [class]="'text-4xl font-black drop-shadow-md ' + lastWildcardEffect()?.color">
        {{ lastWildcardEffect()?.text }}
      </div>
    </div>
    }

    <!-- CRITICAL HIT INDICATOR -->
    @if (lastActionCritical()) {
    <div class="absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 animate-grow-pop pointer-events-none">
      <div class="text-6xl font-black text-yellow-400 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] italic tracking-tighter"
        style="-webkit-text-stroke: 2px #b45309;">
        CRITICAL!
      </div>
      <div class="text-2xl font-bold text-white text-center mt-2 drop-shadow-md">Huge Growth Spurt!</div>
    </div>
    }

    <!-- Overlay UI: Top Bar -->
    <div
      class="absolute top-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md px-6 py-2 rounded-full shadow-xl z-20 flex gap-6 items-center border border-white/50">
      <div class="flex flex-col items-center">
        <span class="text-xs font-black tracking-widest uppercase text-gray-400">Biome</span>
        <span class="font-bold text-gray-800">{{ currentBiome().name }}</span>
      </div>
      <div class="h-8 w-px bg-gray-300"></div>
      <div class="flex flex-col items-center">
        <span class="text-xs font-black tracking-widest uppercase text-amber-500">Score</span>
        <span class="font-bold text-2xl text-amber-600">{{ totalScore() | number }}</span>
      </div>
    </div>

    <!-- Wildcard Items (Bottom Left) -->
    <div class="absolute bottom-8 left-8 flex gap-4 pointer-events-auto items-end">
      <!-- Mystery Potion (500) -->
      @let potionCd = wildcardCooldowns().get('mystery_potion');
      @let potionReady = !potionCd || potionCd < now(); <button (click)="useWildcard('mystery_potion')"
        [disabled]="!potionReady || totalScore() < 500"
        class="group relative flex flex-col items-center disabled:opacity-50 transition-transform active:scale-95">
        <div
          class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg flex items-center justify-center border-2 border-white/30 group-hover:brightness-110">
          <span class="text-3xl">ðŸ§ª</span>
        </div>
        <div class="bg-black/60 text-white text-xs font-bold px-2 py-1 rounded-full mt-[-10px] z-10">500</div>
        @if (!potionReady) {
        <div
          class="absolute inset-0 bg-black/60 rounded-2xl flex items-center justify-center text-white font-bold text-sm">
          {{ ((potionCd || 0) - now()) / 1000 | number:'1.0-0' }}s
        </div>
        }
        </button>

        <!-- Chaos Seed (1500) -->
        @let chaosCd = wildcardCooldowns().get('chaos_seed');
        @let chaosReady = !chaosCd || chaosCd < now(); <button (click)="useWildcard('chaos_seed')"
          [disabled]="!chaosReady || totalScore() < 1500"
          class="group relative flex flex-col items-center disabled:opacity-50 transition-transform active:scale-95">
          <div
            class="w-16 h-16 rounded-2xl bg-gradient-to-br from-red-600 to-orange-600 shadow-lg flex items-center justify-center border-2 border-white/30 group-hover:brightness-110">
            <span class="text-3xl animate-pulse">ðŸ”¥</span>
          </div>
          <div class="bg-black/60 text-white text-xs font-bold px-2 py-1 rounded-full mt-[-10px] z-10">1500</div>
          @if (!chaosReady) {
          <div
            class="absolute inset-0 bg-black/60 rounded-2xl flex items-center justify-center text-white font-bold text-sm">
            {{ ((chaosCd || 0) - now()) / 1000 | number:'1.0-0' }}s
          </div>
          }
          </button>
    </div>

    <!-- Stats & Controls (Bottom Right) -->
    <div class="absolute bottom-8 right-8 flex flex-col items-end gap-4 pointer-events-auto">
      <!-- Growth Multiplier Status -->
      @if (growthMultiplier() !== 1) {
      <div class="bg-yellow-400 text-yellow-900 font-bold px-4 py-2 rounded-xl shadow-lg animate-pulse">
        Growth Speed: {{ growthMultiplier() }}x
      </div>
      }

      <!-- Active Tree Status -->
      <div class="bg-white/90 backdrop-blur-xl p-4 rounded-2xl shadow-lg border border-white/50 w-64">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold text-gray-700">Level {{ activeTree().level }}</span>
          <span class="text-xs text-gray-500">{{ stageLabel() }}</span>
        </div>
        <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
          <div class="h-full bg-green-500 transition-all duration-300"
            [style.width.%]="(activeTree().experience / xpRequired()) * 100"></div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-2">
        <button (click)="waterPlant()"
          class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full shadow-lg transition-transform active:scale-90"
          title="Water (+80 XP)">
          ðŸ’§
        </button>

        @let timeLeft = 60 - ((now() - lastTillTime()) / 1000);
        @let canTill = timeLeft <= 0 || lastTillTime()===0; <button (click)="tillSoil()" [disabled]="!canTill"
          class="bg-amber-600 hover:bg-amber-700 disabled:bg-gray-400 text-white p-4 rounded-full shadow-lg transition-transform active:scale-90 relative"
          title="Till Soil">
          ðŸšœ
          @if (!canTill) {
          <span
            class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">{{
            timeLeft | number:'1.0-0' }}</span>
          }
          </button>
      </div>
    </div>

  </div>

  <!-- Game Over Modal -->
  @if (isGameOver()) {
  <div class="absolute inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm">
    <div
      class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-4 border-amber-500 animate-grow-pop">
      <h2 class="text-4xl font-black text-gray-800 mb-2">Forest Full!</h2>
      <p class="text-gray-500 mb-6">No more space to plant new seeds.</p>

      <div class="py-6 border-y border-gray-100 mb-6">
        <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-1">Final Score</div>
        <div class="text-6xl font-black text-amber-500">{{ totalScore() | number }}</div>
      </div>

      <button (click)="restartGame()"
        class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:brightness-110 active:scale-95 transition-all text-xl">
        Play Again ðŸ”„
      </button>
    </div>
  </div>
  }

</div>